#!/usr/bin/env python3

# Standard lib imports
from os.path import abspath, dirname, join
import sys
import fileinput

# Prepend ../src to $PATH so the project modules can be imported below
src_path = join(dirname(abspath(__file__)), "../src")
sys.path.insert(0, src_path)

# Local project imports
from evm_cfg import EVMOpCFG
from stacksizeanalysis import run_analysis, block_stack_delta
from destackify import Destackifier
import optimise
import tac_cfg

cfg = EVMOpCFG(fileinput.input())

tac_cfg = tac_cfg.TacCfg(cfg)
optimise.fold_constants(tac_cfg)
tac_cfg.recheck_jumps()

blocks = zip(sorted(cfg.blocks, key=lambda block: block.lines[0].pc),
             sorted(tac_cfg.blocks, key=lambda block: block.entry))

for evm, tac in blocks:
  print(evm)
  print(tac)
  print()
