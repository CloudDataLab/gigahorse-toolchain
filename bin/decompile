#!/usr/bin/env python3

# Standard lib imports
from os.path import abspath, dirname, join
import sys
import fileinput

# User-friendly command-line interface
import argparse
parser = argparse.ArgumentParser(description='An EVM bytecode disassembly decompiler that generates files for program analysis.')
parser.add_argument('--file', '-f', type=open)
args = parser.parse_args()

# Prepend ../src to $PATH so the project modules can be imported below
src_path = join(dirname(abspath(__file__)), "../src")
sys.path.insert(0, src_path)

# Local project imports
import optimise
import tac_cfg
import blockparse

cfg = None

if args.file == None:
    cfg = tac_cfg.TACGraph.from_dasm(fileinput.input())
else:
    cfg = tac_cfg.TACGraph.from_dasm(args.file)

optimise.fold_constants(cfg)
cfg.recheck_jumps()

print(cfg)
